var Guitar=function(r,t){"use strict";var n,e,o,i,a=this,s=a.tools={},f={};a.init=function(){a.id=r,a.container=document.getElementById(r),a.container.style.overflow="hidden",a.canvas=document.createElement("canvas"),a.container.appendChild(a.canvas),a.context=a.canvas.getContext("2d"),a.events={},n=a.settings,e=a.context,o=a.canvas,i=a.events,addEventListener("resize",a.redraw),o.addEventListener("click",a.onclick),o.addEventListener("mousemove",a.onmove)},a.mock=function(){a.id=r,a.container={offsetWidth:500,offsetHeight:500},a.canvas={width:500,height:150},a.context={clearRect:function(){},beginPath:function(){},arc:function(){},fill:function(){},stroke:function(){},closePath:function(){},moveTo:function(){},lineTo:function(){},save:function(){},restore:function(){},measureText:function(){return{width:1/0}},scale:function(){},fillText:function(){}},a.events={},n=a.settings,e=a.context,o=a.canvas,i=a.events},a.set=function(r){return 2===arguments.length?a.setOne.apply(arguments):a.setMultiple(r)},a.setOne=function(r,t){var n={};n[r]=t,a.setMultiple(n)},a.setMultiple=function(r){for(var t in r)r.hasOwnProperty(t)&&(n[t]=r[t]);if(n["fret-count"]=n["end-fret"]-n["start-fret"]+1,a.frets=s.range(n["start-fret"],n["end-fret"]),a.frets0=[0].concat(a.frets),a.strings=s.range(0,n["string-count"]-1),"vertical"===n.orientation)a["long"]=a.height,a["short"]=a.width,a.coords=function(r,t){return[t,r]};else if("horizontal"===n.orientation)a["long"]=a.width,a["short"]=a.height,a.coords=function(r,t){return[r,t]};else{if("auto"!==n.orientation)throw Error("Option orientation must be vertical, horizontal or auto");a["long"]=function(){return s.max([o.width,o.height])},a["short"]=function(){return s.min([o.width,o.height])},a.coords=function(r,t){return o.width>=o.height?[r,t]:[t,r]}}a.redraw()},a.mark=function(r,t,e,o,i,s){a.unmark(r,t);var f=r;1!==arguments.length&&(f={string:r,fret:t},e&&(f.text=e),o&&(f.size=o),i&&(f.color=i),s&&(f.border=s)),n.marks.push(f),a.redraw()},a.unmark=function(r,t){var e=a.findMark(r,t);-1!==e&&(n.marks.splice(e,1),a.redraw())},a.switchMark=function(r,t,n,e,o,i){a.isMarked(r,t)?a.mark.apply(arguments):a.unmark.apply(arguments)},a.resetMarks=function(){n.marks=[],a.redraw()},a.findMark=function(r,t){1===arguments.length&&(t=r.fret,r=r.string);var e=-1;return n.marks.forEach(function(n,o){n.string===r&&n.fret===t&&(e=o)}),e},a.isMarked=function(r,t){return-1!==a.findMark(r,t)},a.tune=function(r){r instanceof String&&(r=r.toLowerCase());var t={eadgbe:["E2","A2","D3","G3","B3","E4"],"default":["E2","A2","D3","G3","B3","E4"],"drop-d":["D2","A2","D3","G3","B3","E4"]};t[r]&&(r=t[r]),a.set("tuning",r.map(f.parseNote))},a.width=function(){return o.width},a.height=function(){return o.height},a.workLong=function(){return a["long"]()-n["bridge-margin"]-n["space-margin"]},a.startShort=function(){return a["short"]()-2*(n["start-border-margin"]+n["string-outer-margin"])},a.endShort=function(){return a["short"]()-2*(n["end-border-margin"]+n["string-outer-margin"])},a.startStringGap=function(){return a.startShort()/(n["string-count"]-1)},a.endStringGap=function(){return a.endShort()/(n["string-count"]-1)},a.startStringS=function(r){if("right-to-left"===n["string-order"]||"bottom-to-top"===n["string-order"])return n["start-border-margin"]+n["string-outer-margin"]+(n["string-count"]-r-1)*a.startStringGap(r);if("left-to-right"===n["string-order"]||"top-to-bottom"===n["string-order"])return n["start-border-margin"]+n["string-outer-margin"]+r*a.startStringGap(r);throw Error("String-order option must be left-to-right, top-to-bottom, right-to-left or bottom-to-top")},a.endStringS=function(r){if("right-to-left"===n["string-order"]||"bottom-to-top"===n["string-order"])return n["end-border-margin"]+n["string-outer-margin"]+(n["string-count"]-r-1)*a.endStringGap(r);if("left-to-right"===n["string-order"]||"top-to-bottom"===n["string-order"])return n["end-border-margin"]+n["string-outer-margin"]+r*a.endStringGap(r);throw Error("String-order option must be left-to-right, top-to-bottom, right-to-left or bottom-to-top")},a.stringSByFretL=function(r,t){var n=a.startStringS(r),e=a.endStringS(r),o=t/a.workLong();return n*(1-o)+e*o},a.stringInterS=function(r,t){var n=a.interFretL(t);return a.stringSByFretL(r,n)},a.stringS=function(r,t){var n=a.fretL(t);return a.stringSByFretL(r,n)},a.redraw=function(){o.width=a.container.offsetWidth,o.height=a.container.offsetHeight,a.rebuildFrets(),e.clearRect(0,0,o.width,o.height),a.frets.forEach(function(r){var t=n["fret-signs"][r];t&&a.drawSign(r,t)}),a.frets.forEach(a.drawFret),a.frets.forEach(a.drawFretNumber),a.strings.forEach(a.drawString),n["show-tuning"]&&a.strings.forEach(a.drawTuning),a.drawBridge(),n.marks.forEach(a.drawMark)},a.rebuildFrets=function(){if(this.oldLong!==a["long"]()){if("real"===n.scale){var r=a.fretCoeff();a.fretLs=[0];for(var t=0;t<n["fret-count"];++t)a.fretLs[t]+=r[t],a.fretLs[t+1]=a.fretLs[t]}else{if("linear"!==n.scale)throw Error("Unknown scale option value: "+n.scale);a.fretLs=[];for(var t=0;t<n["fret-count"];++t)a.fretLs[t]=(a.workLong()-n["fret-width"])*(t+1)/n["fret-count"]}this.oldLong=a["long"]()}},a.fretCoeff=function(){for(var r=s.rawCoeff().slice(0,n["fret-count"]),t=(a.workLong()-n["fret-width"])/s.sum(r),e=[],o=0;o<n["fret-count"];++o)e[o]=r[o]*t;return e},a.fretL=function(r){return 0===r?0:a.fretLs[r-n["start-fret"]]},a.interFretL=function(r,t){t=void 0===t?.5:t;var n=a.fretL(r-1)||0,e=a.fretL(r);return n*(1-t)+e*t},a.fretShortByL=function(r){var t=r/a.workLong();return a.startShort()*(1-t)+a.endShort()*t},a.fretShort=function(r){var t=a.fretL(r);return a.fretShortByL(t)},a.stringWidth=function(r){var t=n["string-width"];if("number"==typeof t)return t;if(t instanceof Array)return t[r];if(t instanceof Function)return t(r);throw Error("string-width must be Number, Array (of Numbers) or Function")},a.fretByL=function(r){for(var t=0,e=1/0,o=s.range(n["start-fret"],n["end-fret"]).concat([0]),i=0;i<o.length;++i){var f=o[i],u=a.interFretL(f,.55)+n["bridge-margin"],c=Math.abs(u-r);e>c&&(t=f,e=c)}return{value:t,threshold:e}},a.stringByS=function(r,t){for(var e=0,o=1/0,i=0;i<n["string-count"];++i){var s=a.stringS(i,t),f=Math.abs(s-r);o>f&&(e=i,o=f)}return{value:e,threshold:o}},a.drawBridge=function(){var r=n["bridge-margin"],t=n["start-border-margin"],e=n["bridge-margin"],o=a["short"]()-n["start-border-margin"];s.drawLine(r,t,e,o,n["bridge-color"],n["bridge-width"])},a.drawTuning=function(r){var t=n["bridge-margin"]/2,e=a.startStringS(r),o=f.showNote(n.tuning[n["string-count"]-1-r],n["show-tuning"]);s.drawScaledText(o,t,e,n["tuning-font"],n["tuning-color"],a.startStringGap(),0,0)},a.drawString=function(r){var t=n["bridge-margin"],e=a.startStringS(r),o=a["long"]()-n["space-margin"],i=a.endStringS(r);s.drawLine(t,e,o,i,n["string-color"],a.stringWidth(r))},a.drawFret=function(r){var t=a.fretL(r)+n["bridge-margin"],e=(a["short"]()-a.fretShort(r))/2,o=t,i=a["short"]()-e;s.drawLine(t,e,o,i,n["fret-color"],n["fret-width"])},a.drawFretNumber=function(r){var t=a.interFretL(r)+n["bridge-margin"],e=a.fretL(r)-a.fretL(r-1),o=a.fretShortByL(t),i=(a["short"]()-o)/2,f=0,u=0,c=0;if("left"===n["fret-number-side"]||"top"===n["fret-number-side"])f=i-n["fret-number-margin"],c=-1;else{if("right"!==n["fret-number-side"]&&"bottom"!==n["fret-number-side"])throw Error("Fret-number-side option must be left, right, top or bottom");f=a["short"]()-i+n["fret-number-margin"],c=1}s.drawScaledText(r,t,f,n["fret-number-font"],n["fret-number-color"],e,u,c)},a.drawSign=function(r,t){var e=a.interFretL(r)+n["bridge-margin"],o=a["short"]()/2,i=a.fretShortByL(e)/4,f=n["sign-size"];if("dot"===t)s.drawCircle(e,o,f,n["sign-color"]);else if("star"===t)s.drawStar(e,o,f,5,n["sign-color"]);else if("double-dot"===t)s.drawCircle(e,o-i,f,n["sign-color"]),s.drawCircle(e,o+i,f,n["sign-color"]);else{if("double-star"!==t)throw Error("Unknown sign type: "+t);s.drawStar(e,o-i,f,5,n["sign-color"]),s.drawStar(e,o+i,f,5,n["sign-color"])}},a.drawMark=function(r){var t=a.interFretL(r.fret,n["mark-position"]),e=(a.fretShortByL(t),t+n["bridge-margin"]),o=a.stringSByFretL(r.string,t),i=r.size||n["mark-size"],u=r.color||n["mark-color"],c=r.border||n["mark-border"];if(u instanceof Array){var d=Math.floor(Math.random()*u.length);u=r.color=u[d]}s.drawCircle(e,o,i,u,c.size,c.color);var g=r.text||n["mark-text"];if(!r.text){var l=n.tuning[n["string-count"]-1-r.string],h=l+r.fret;g=f.showNote(h,n["show-notes"])}var m=s.chooseForeground(u);s.drawScaledText(g,e,o,n["mark-font"],m,i,0,0)},a.addEventListener=function(r,t){i[r]=i[r]||[],i[r].push(t)},a.removeEventListener=function(r,t){i[r]=i[r]||[];var n=i[r].indexOf(t);-1!==n&&i[r].splice(n,1)},a.onclick=function(r){for(var t=a.coords(r.offsetX,r.offsetY),n=a.fretByL(t[0]),e=a.stringByS(t[1],n.value),o=i.click||[],s=0;s<o.length;++s)o[s](e,n,r)},a.onmove=function(r){for(var t=a.coords(r.offsetX,r.offsetY),n=a.fretByL(t[0]),e=a.stringByS(t[1],n.value),o=i.move||[],s=0;s<o.length;++s)o[s](e,n,r)},s.drawLine=function(r,t,n,o,i,s){var f=a.coords(r,t),u=a.coords(n,o);e.beginPath(),e.lineWidth=s,e.strokeStyle=i;var c=s%2===0?0:.5;e.moveTo(Math.round(f[0])+c,Math.round(f[1])+c),e.lineTo(Math.round(u[0])+c,Math.round(u[1])+c),e.stroke(),e.closePath()},s.drawCircle=function(r,t,n,o,i,s){var f=a.coords(r,t);e.beginPath(),e.lineWidth=i,e.strokeStyle=s,e.arc(f[0],f[1],n,0,2*Math.PI,!1),e.fillStyle=o,e.fill(),i&&s&&e.stroke(),e.closePath()},s.aToTa=function(r,t){var n=a.coords(r,t)[0];return-1===n?"right":0===n?"center":1===n?"left":void 0},s.aToTb=function(r,t){var n=a.coords(r,t)[1];return-1===n?"bottom":0===n?"middle":1===n?"top":void 0},s.drawScaledText=function(r,t,n,o,i,f,u,c){var d=a.coords(t,n);e.save(),e.font=o,e.textAlign=s.aToTa(u,c),e.fillStyle=i,e.textBaseline=s.aToTb(u,c);var g=e.measureText(r),l=g.width,h=1;l>f&&(h=f/l,e.scale(h,h)),e.fillText(r,d[0]/h,d[1]/h),e.restore()},s.drawStar=function(r,t,n,o,i){var s=a.coords(r,t);e.save(),e.beginPath(),e.translate(s[0],s[1]),e.fillStyle=i,e.moveTo(0,0-n);for(var f=0;o>f;f++)e.rotate(Math.PI/o),e.lineTo(0,0-.5*n),e.rotate(Math.PI/o),e.lineTo(0,0-n);e.fill(),e.closePath(),e.restore()},s.sum=function(r){return r.reduce(function(r,t){return r+t},0)},s.max=function(r){return r.reduce(function(r,t){return r>t?r:t})},s.min=function(r){return r.reduce(function(r,t){return t>r?r:t})},s.range=function(r,t,n){var e=[];for("undefined"==typeof n&&(n=1);n>0?t>=r:r>=t;)e.push(r),r+=n;return e},s.rawCoeff=function(){if(void 0===this.result){this.result=[];for(var r=0;100>r;++r)this.result[r]=Math.pow(2,-r/12)}return this.result},s.parseColor=function(r){var t=function(r){return parseInt(r,10)},n=r.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(n)return n.slice(1,4).map(function(r){return parseInt(r,16)});var n=r.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);if(n)return n.slice(1,4).map(function(r){return 17*parseInt(r,16)});var e=/(.*?)rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/.exec(r);return 5===e.length?e.slice(2).map(t):null},s.chooseForeground=function(r){var t=s.parseColor(r),n=s.max(t),e=127;return n>=e?"#333":"#fafafa"},f.parseNote=function(r){var t=r[0],n=r[1],e=r[r.length-1],o=0;"#"===n?o=1:"b"===n&&(o=-1);var i="C-D-EF-G-A-B".indexOf(t),a=i+o,s=parseInt(e),f=a+12*s;return f},f.showNote=function(r,t){var n=r%12,e=(r-n)/12,o=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][n]+e;if("simple"===t)return o.slice(0,o.length-1);if("full"===t)return o;throw Error("Unknown show note mode")},a.settings={"bridge-margin":30,"start-border-margin":15,"end-border-margin":15,"string-outer-margin":5,"space-margin":5,"fret-number-margin":3,"mark-position":.55,"mark-border":{size:2,color:"#666"},"string-color":"#333","bridge-color":"#777","fret-color":"#bbb","sign-color":"#ccc","fret-number-color":"#aaa","mark-color":"#fefefe","tuning-color":"#222","string-width":1,"bridge-width":6,"fret-width":3,"fret-number-font":"12px sans-serif","mark-font":"12px sans-serif","tuning-font":"15px sans-serif","sign-size":6,"mark-size":13,orientation:"horizontal",scale:"real","mark-text":"","show-notes":"simple","show-tuning":"simple","string-order":"top-to-bottom","fret-number-side":"bottom","string-count":6,"start-fret":1,"end-fret":12,tuning:["E2","A2","D3","G3","B3","E4"].map(f.parseNote),"fret-signs":{3:"dot",5:"dot",7:"double-dot",9:"dot",12:"double-dot",15:"dot",17:"dot",19:"dot",21:"dot",24:"double-dot"},marks:[]},"undefined"!=typeof document?a.init():a.mock(),a.set(t)};"undefined"==typeof module||(module.exports=Guitar);