var Guitar=function(r,t){"use strict";var e,n,o,i,a=this,s=a.tools={},f=a.notes={};a.init=function(t){a.id=r,a.container=t.document.getElementById(r),a.container.style.overflow="hidden",a.canvas=t.document.createElement("canvas"),a.container.appendChild(a.canvas),a.context=a.canvas.getContext("2d"),a.events={},e=a.settings,n=a.context,o=a.canvas,i=a.events,t.addEventListener("resize",a.redraw),o.addEventListener("click",a.onclick),o.addEventListener("mousemove",a.onmove)},a.set=function(r){return 2===arguments.length?a.setOne.apply(this,arguments):a.setMultiple(r)},a.setOne=function(r,t){var e={};e[r]=t,a.setMultiple(e)},a.setMultiple=function(r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t],"scale"===t&&(a.rebuildFrets.oldLong="FUCKING UPDATE"));if(e["fret-count"]=e["end-fret"]-e["start-fret"]+1,a.frets=s.range(e["start-fret"],e["end-fret"]),a.frets0=[0].concat(a.frets),a.strings=s.range(0,e["string-count"]-1),"vertical"===e.orientation)a["long"]=a.height,a["short"]=a.width,a.coords=function(r,t){return[t,r]};else if("horizontal"===e.orientation)a["long"]=a.width,a["short"]=a.height,a.coords=function(r,t){return[r,t]};else{if("auto"!==e.orientation)throw Error("Option orientation must be vertical, horizontal or auto, but was "+e.orientation);a["long"]=function(){return s.max([o.width,o.height])},a["short"]=function(){return s.min([o.width,o.height])},a.coords=function(r,t){return o.width>=o.height?[r,t]:[t,r]}}a.redraw()},a.mark=function(r,t,n,o,i,s){a.unmark(r,t);var f=r;void 0!==t&&(f={string:r,fret:t},n&&(f.text=n),o&&(f.size=o),i&&(f.color=i),s&&(f.border=s)),e.marks.push(f),a.redraw()},a.unmark=function(r,t){var n=a.findMark(r,t);-1!==n&&(e.marks.splice(n,1),a.redraw())},a.switchMark=function(r,t,e,n,o,i){a.isMarked(r,t)?a.unmark.apply(this,arguments):a.mark.apply(this,arguments)},a.resetMarks=function(){e.marks=[],a.redraw()},a.findMark=function(r,t){void 0===t&&(t=r.fret,r=r.string);for(var n=0;n<e.marks.length;++n)if(e.marks[n].string===r&&e.marks[n].fret===t)return n;return-1},a.isMarked=function(r,t){return-1!==a.findMark(r,t)},a.tune=function(r){var t={eadgbe:["E2","A2","D3","G3","B3","E4"],"default":["E2","A2","D3","G3","B3","E4"],"drop-d":["D2","A2","D3","G3","B3","E4"]};"string"==typeof r&&(r=r.toLowerCase(),r=t[r]),a.set("tuning",r.map(f.parseNote))},a.width=function(){return o.width},a.height=function(){return o.height},a.workLong=function(){return a["long"]()-e["bridge-margin"]-e["space-margin"]},a.startShort=function(){return a["short"]()-2*(e["start-border-margin"]+e["string-outer-margin"])},a.endShort=function(){return a["short"]()-2*(e["end-border-margin"]+e["string-outer-margin"])},a.startStringGap=function(){return a.startShort()/(e["string-count"]-1)},a.endStringGap=function(){return a.endShort()/(e["string-count"]-1)},a.startStringS=function(r){if("right-to-left"===e["string-order"]||"bottom-to-top"===e["string-order"])return e["start-border-margin"]+e["string-outer-margin"]+(e["string-count"]-r-1)*a.startStringGap(r);if("left-to-right"===e["string-order"]||"top-to-bottom"===e["string-order"])return e["start-border-margin"]+e["string-outer-margin"]+r*a.startStringGap(r);throw Error("String-order option must be left-to-right, top-to-bottom, right-to-left or bottom-to-top")},a.endStringS=function(r){if("right-to-left"===e["string-order"]||"bottom-to-top"===e["string-order"])return e["end-border-margin"]+e["string-outer-margin"]+(e["string-count"]-r-1)*a.endStringGap(r);if("left-to-right"===e["string-order"]||"top-to-bottom"===e["string-order"])return e["end-border-margin"]+e["string-outer-margin"]+r*a.endStringGap(r);throw Error("String-order option must be left-to-right, top-to-bottom, right-to-left or bottom-to-top")},a.stringSByFretL=function(r,t){var e=a.startStringS(r),n=a.endStringS(r),o=t/a.workLong();return e*(1-o)+n*o},a.stringS=function(r,t){var e=a.fretL(t);return a.stringSByFretL(r,e)},a.redraw=function(){o.width=a.container.offsetWidth,o.height=a.container.offsetHeight,a.rebuildFrets(),n.clearRect(0,0,o.width,o.height);for(var r in e["fret-colors"])if(e["fret-colors"].hasOwnProperty(r)){var t=e["fret-colors"][r];a.highlightFret(r,t)}a.frets.forEach(function(r){var t=e["fret-signs"][r];t&&a.drawSign(r,t)}),a.frets.forEach(a.drawFret),a.frets.forEach(a.drawFretNumber),a.strings.forEach(a.drawString),e.capo&&a.drawCapo(e.capo),e["show-tuning"]&&a.strings.forEach(a.drawTuning),a.drawBridge(),e.marks.forEach(a.drawMark)},a.rebuildFrets=function(){var r=a.rebuildFrets;if(r.oldLong!==a["long"]()){if("real"===e.scale){var t=a.fretCoeff();a.fretLs=[0];for(var n=0;n<e["fret-count"];++n)a.fretLs[n]+=t[n],a.fretLs[n+1]=a.fretLs[n]}else{if("linear"!==e.scale)throw Error("Unknown scale option value: "+e.scale);a.fretLs=[];for(var o=0;o<e["fret-count"];++o)a.fretLs[o]=(a.workLong()-e["fret-width"])*(o+1)/e["fret-count"]}r.oldLong=a["long"]()}},a.fretCoeff=function(){for(var r=s.rawCoeff().slice(0,e["fret-count"]),t=(a.workLong()-e["fret-width"])/s.sum(r),n=[],o=0;o<e["fret-count"];++o)n[o]=r[o]*t;return n},a.fretL=function(r){return 0===r?0:a.fretLs[r-e["start-fret"]]},a.interFretL=function(r,t){t=void 0===t?.5:t;var e=a.fretL(r-1)||0,n=a.fretL(r);return e*(1-t)+n*t},a.fretShortByL=function(r){var t=r/a.workLong();return a.startShort()*(1-t)+a.endShort()*t},a.fretShort=function(r){var t=a.fretL(r);return a.fretShortByL(t)},a.stringWidth=function(r){var t=e["string-width"];if("number"==typeof t)return t;if(t instanceof Array)return t[r];if(t instanceof Function)return t(r);throw Error("string-width must be Number, Array (of Numbers) or Function")},a.fretByL=function(r){for(var t=0,n=1/0,o=s.range(e["start-fret"],e["end-fret"]).concat([0]),i=0;i<o.length;++i){var f=o[i],u=a.interFretL(f,.55)+e["bridge-margin"],d=Math.abs(u-r);n>d&&(t=f,n=d)}return{value:t,threshold:n}},a.stringByS=function(r,t){for(var n=0,o=1/0,i=0;i<e["string-count"];++i){var s=a.stringS(i,t),f=Math.abs(s-r);o>f&&(n=i,o=f)}return{value:n,threshold:o}},a.drawBridge=function(){var r=e["bridge-margin"],t=e["start-border-margin"],n=e["bridge-margin"],o=a["short"]()-e["start-border-margin"];s.drawLine(r,t,n,o,e["bridge-color"],e["bridge-width"])},a.drawCapo=function(r){if(!(r>e["end-fret"])){var t=a.interFretL(r)+e["bridge-margin"],n=t,o=(a.fretShort(r-1)+a.fretShort(r))/2,i=(a["short"]()-o)/2-e["capo-bulge"],f=i,u=a["short"]()-i;s.drawLine(t,f,n,u,e["capo-color"],e["capo-width"])}},a.drawTuning=function(r){if(!e["hide-marked-tuning"]||!a.isMarked(r,0)){var t=e["bridge-margin"]/2,n=a.startStringS(r),o=f.showNote(e.tuning[e["string-count"]-1-r],e["show-tuning"]);s.drawScaledText(o,t,n,e["tuning-font"],e["tuning-color"],a.startStringGap(),0,0)}},a.drawString=function(r){var t=e["bridge-margin"],n=a.startStringS(r),o=a["long"]()-e["space-margin"],i=a.endStringS(r),f=e["string-color"];if("string"==typeof f);else{if(!(f instanceof Array))throw new Error("string-color must be string or array");f=f[r]}s.drawLine(t,n,o,i,f,a.stringWidth(r))},a.drawFret=function(r){var t=a.fretL(r)+e["bridge-margin"],n=(a["short"]()-a.fretShort(r))/2,o=t,i=a["short"]()-n;s.drawLine(t,n,o,i,e["fret-color"],e["fret-width"])},a.highlightFret=function(r,t){var n=a.fretL(r-1)+e["bridge-margin"],o=(a["short"]()-a.fretShortByL(n))/2,i=a.fretL(r)+e["bridge-margin"],f=a["short"]()-o;s.drawRect(n,o,i,f,t)},a.drawFretNumber=function(r){var t=a.interFretL(r)+e["bridge-margin"],n=a.fretL(r)-a.fretL(r-1),o=a.fretShortByL(t),i=(a["short"]()-o)/2,f=0,u=0,d=0;if("left"===e["fret-number-side"]||"top"===e["fret-number-side"])f=i-e["fret-number-margin"],d=-1;else{if("right"!==e["fret-number-side"]&&"bottom"!==e["fret-number-side"])throw Error("Fret-number-side option must be left, right, top or bottom");f=a["short"]()-i+e["fret-number-margin"],d=1}s.drawScaledText(r,t,f,e["fret-number-font"],e["fret-number-color"],n,u,d)},a.drawSign=function(r,t){var n=a.interFretL(r)+e["bridge-margin"],o=a["short"]()/2,i=a.fretShortByL(n)/4,f=e["sign-size"];if("dot"===t)s.drawCircle(n,o,f,e["sign-color"]);else if("star"===t)s.drawStar(n,o,f,5,e["sign-color"]);else if("double-dot"===t)s.drawCircle(n,o-i,f,e["sign-color"]),s.drawCircle(n,o+i,f,e["sign-color"]);else{if("double-star"!==t)throw Error("Unknown sign type: "+t);s.drawStar(n,o-i,f,5,e["sign-color"]),s.drawStar(n,o+i,f,5,e["sign-color"])}},a.drawMark=function(r){var t=a.interFretL(r.fret,e["mark-position"]),n=(a.fretShortByL(t),t+e["bridge-margin"]),o=a.stringSByFretL(r.string,t),i=r.size||e["mark-size"],u=r.color||e["mark-color"],d=r.border||e["mark-border"];if(u instanceof Array){var c=Math.floor(Math.random()*u.length);u=r.color=u[c]}s.drawCircle(n,o,i,u,d.size,d.color);var g=r.text||e["mark-text"];if(!r.text){var l=e.tuning[e["string-count"]-1-r.string],h=l+r.fret;g=f.showNote(h,e["show-notes"])}var m=s.chooseForeground(u);s.drawScaledText(g,n,o,e["mark-font"],m,i,0,0)},a.addEventListener=function(r,t){i[r]=i[r]||[],i[r].push(t)},a.removeEventListener=function(r,t){i[r]=i[r]||[];var e=i[r].indexOf(t);-1!==e&&i[r].splice(e,1)},a.onclick=function(r){for(var t=a.coords(r.offsetX,r.offsetY),e=a.fretByL(t[0]),n=a.stringByS(t[1],e.value),o=i.click||[],s=0;s<o.length;++s)o[s](n,e,r)},a.onmove=function(r){for(var t=a.coords(r.offsetX,r.offsetY),e=a.fretByL(t[0]),n=a.stringByS(t[1],e.value),o=i.move||[],s=0;s<o.length;++s)o[s](n,e,r)},s.drawLine=function(r,t,e,o,i,s){var f=a.coords(r,t),u=a.coords(e,o);n.beginPath(),n.lineWidth=s,n.strokeStyle=i;var d=s%2===0?0:.5;n.moveTo(Math.round(f[0])+d,Math.round(f[1])+d),n.lineTo(Math.round(u[0])+d,Math.round(u[1])+d),n.stroke(),n.closePath()},s.drawRect=function(r,t,e,o,i){var s=a.coords(r,t),f=a.coords(e,o);n.beginPath(),n.fillStyle=i,n.fillRect(s[0],s[1],f[0]-s[0],f[1]-s[1]),n.stroke(),n.closePath()},s.drawCircle=function(r,t,e,o,i,s){var f=a.coords(r,t);n.beginPath(),n.lineWidth=i,n.strokeStyle=s,n.arc(f[0],f[1],e,0,2*Math.PI,!1),n.fillStyle=o,n.fill(),i&&s&&n.stroke(),n.closePath()},s.aToTa=function(r,t){var e=a.coords(r,t)[0];return-1===e?"right":0===e?"center":1===e?"left":void 0},s.aToTb=function(r,t){var e=a.coords(r,t)[1];return-1===e?"bottom":0===e?"middle":1===e?"top":void 0},s.drawScaledText=function(r,t,e,o,i,f,u,d){var c=a.coords(t,e);n.save(),n.font=o,n.textAlign=s.aToTa(u,d),n.fillStyle=i,n.textBaseline=s.aToTb(u,d);var g=n.measureText(r),l=g.width,h=1;l>f&&(h=f/l,n.scale(h,h)),n.fillText(r,c[0]/h,c[1]/h),n.restore()},s.drawStar=function(r,t,e,o,i){var s=a.coords(r,t);n.save(),n.beginPath(),n.translate(s[0],s[1]),n.fillStyle=i,n.moveTo(0,0-e);for(var f=0;o>f;f++)n.rotate(Math.PI/o),n.lineTo(0,0-.5*e),n.rotate(Math.PI/o),n.lineTo(0,0-e);n.fill(),n.closePath(),n.restore()},s.sum=function(r){return r.reduce(function(r,t){return r+t},0)},s.max=function(r){return r.reduce(function(r,t){return r>t?r:t})},s.min=function(r){return r.reduce(function(r,t){return t>r?r:t})},s.range=function(r,t,e){e=e||1;for(var n=[];e>0?t>=r:r>=t;)n.push(r),r+=e;return n},s.rawCoeff=function(){if(void 0===this.result){this.result=[];for(var r=0;100>r;++r)this.result[r]=Math.pow(2,-r/12)}return this.result},s.parseColor=function(r){var t=function(r){return parseInt(r,10)},e=r.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(e)return e.slice(1,4).map(function(r){return parseInt(r,16)});var n=r.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);if(n)return n.slice(1,4).map(function(r){return 17*parseInt(r,16)});var o=/(.*?)rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/.exec(r);if(o&&5===o.length)return o.slice(2).map(t);var i=/(.*?)rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\,\s*(\d+)\s*\)/.exec(r);return i&&6===i.length?i.slice(2).map(t):null},s.isDark=function(r){var t=s.parseColor(r),e=t[0],n=t[1],o=t[2],i=.25*e+.5*n+.25*o,a=127;return a>=i},s.isLight=function(r){return!s.isDark(r)},s.chooseForeground=function(r){return s.isLight(r)?"#333":"#fafafa"},f.parseNote=function(r){var t=r[0],e=r[1],n=r[r.length-1],o=0;"#"===e?o=1:"b"===e&&(o=-1);var i="C-D-EF-G-A-B".indexOf(t),a=i+o,s=parseInt(n),f=a+12*s;return f},f.showNote=function(r,t){var e=r%12,n=(r-e)/12,o=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e]+n;if("simple"===t)return o.slice(0,o.length-1);if(void 0===t||"full"===t)return o;throw Error("Unknown show note mode")},a.settings={"bridge-margin":30,"start-border-margin":15,"end-border-margin":15,"string-outer-margin":5,"space-margin":5,"fret-number-margin":3,"capo-bulge":5,"mark-position":.55,"mark-border":{size:2,color:"#666"},"string-color":"#333","bridge-color":"#777","fret-color":"#bbb","sign-color":"#ccc","fret-number-color":"#aaa","mark-color":"#fefefe","tuning-color":"#222","capo-color":"#333","string-width":1,"bridge-width":6,"fret-width":3,"capo-width":12,"fret-number-font":"12px sans-serif","mark-font":"12px sans-serif","tuning-font":"15px sans-serif","sign-size":6,"mark-size":13,orientation:"horizontal",scale:"real","mark-text":"","show-notes":"simple","show-tuning":"simple","hide-marked-tuning":!1,capo:null,"fret-colors":{},"string-order":"top-to-bottom","fret-number-side":"bottom","string-count":6,"start-fret":1,"end-fret":12,tuning:["E2","A2","D3","G3","B3","E4"].map(f.parseNote),"fret-signs":{3:"dot",5:"dot",7:"double-dot",9:"dot",12:"double-dot",15:"dot",17:"dot",19:"dot",21:"dot",24:"double-dot"},marks:[]};var u="undefined"!=typeof window?window:r;a.init(u),a.set(t)};"undefined"!=typeof module&&(module.exports=Guitar);